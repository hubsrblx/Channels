-- JohnAim Ultimate Script v2.2
-- [Murder Mystery 2] Aimbot + Auto Gun + ESP

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Цвета из john2
local BLACK_MAIN = Color3.fromRGB(25, 25, 25)
local PURPLE_ACCENT = Color3.fromRGB(170, 0, 255)
local WHITE_TEXT = Color3.fromRGB(255, 255, 255)
local DARK_GRAY_HEADER = Color3.fromRGB(40, 40, 40)
local RED_CLOSE = Color3.fromRGB(255, 80, 80)
local GRAY_NOTE = Color3.fromRGB(170, 170, 170)

-- Шрифты из john2
local MAIN_FONT = Enum.Font.ArimoBold
local SPECIAL_FONT = Enum.Font.FredokaOne

-- Состояния
local roles = {}
local Murder, Sheriff, Hero
local ESPEnabled = false -- Выключен по умолчанию
local AutoGetGun = { Enabled = false, CollectDistance = 5000 }
local MainGUI, ShootGUI
local _G.JohnAimLoaded = true -- Глобальный флаг загрузки

-- Функция проверки загрузки
local function IsLoaded()
    return _G.JohnAimLoaded == true
end

-- Функции ESP
local function IsAlive(Player)
    for i, v in pairs(roles) do
        if Player.Name == i then
            return not v.Killed and not v.Dead
        end
    end
    return false
end

local function CreateHighlight()
    if not ESPEnabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and not player.Character:FindFirstChild("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Parent = player.Character
            highlight.OutlineTransparency = 0.5
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        end
    end
end

local function UpdateHighlights()
    if not ESPEnabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Highlight") then
            local Highlight = player.Character:FindFirstChild("Highlight")
            if player.Name == Sheriff and IsAlive(player) then
                Highlight.FillColor = Color3.fromRGB(0, 0, 225)
                Highlight.OutlineColor = Color3.fromRGB(0, 0, 150)
            elseif player.Name == Murder and IsAlive(player) then
                Highlight.FillColor = Color3.fromRGB(225, 0, 0)
                Highlight.OutlineColor = Color3.fromRGB(150, 0, 0)
            elseif player.Name == Hero and IsAlive(player) and not IsAlive(Players[Sheriff]) then
                Highlight.FillColor = Color3.fromRGB(255, 250, 0)
                Highlight.OutlineColor = Color3.fromRGB(200, 200, 0)
            else
                Highlight.FillColor = Color3.fromRGB(0, 225, 0)
                Highlight.OutlineColor = Color3.fromRGB(0, 150, 0)
            end
        end
    end
end

-- Функции Auto Gun
local function isMurderer()
    local char = LocalPlayer.Character
    if not char then return false end
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and tool.Name == "Knife" then
            return true
        end
    end
    return false
end

local function getNearestGun()
    local char = LocalPlayer.Character
    if not char then return nil end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end

    local closestGun, closestDist = nil, AutoGetGun.CollectDistance
    for _, item in ipairs(Workspace:GetDescendants()) do
        if item.Name == "GunDrop" then
            local success, pos = pcall(function() return item:GetPivot().Position end)
            if success then
                local dist = (root.Position - pos).Magnitude
                if dist < closestDist then
                    closestGun, closestDist = item, dist
                end
            end
        end
    end
    return closestGun
end

local function teleportToGunAndBack()
    if isMurderer() then return end
    local char = LocalPlayer.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    local gun = getNearestGun()
    if not gun then return end

    local originalCFrame = root.CFrame
    root.CFrame = CFrame.new(gun:GetPivot().Position + Vector3.new(0, 2, 0))

    local timeout = tick() + 2
    while gun:IsDescendantOf(Workspace) and tick() < timeout do
        task.wait(0.1)
    end

    root.CFrame = originalCFrame
end

-- Функция создания основного GUI
local function CreateMainGUI()
    if MainGUI and MainGUI.Parent then return end
    if MainGUI then MainGUI:Destroy() end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "JohnAimGUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    MainGUI = ScreenGui

    -- Основное окно
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 160, 0, 90) -- Уменьшена высота
    MainFrame.Position = UDim2.new(0.5, -80, 0.5, -45)
    MainFrame.BackgroundColor3 = BLACK_MAIN
    MainFrame.BackgroundTransparency = 0.03
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui

    local UIStroke = Instance.new("UIStroke")
    UIStroke.Thickness = 2
    UIStroke.Color = Color3.fromRGB(100, 100, 100)
    UIStroke.Transparency = 0.5
    UIStroke.Parent = MainFrame

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = MainFrame

    -- Заголовок с кнопкой закрытия
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.Size = UDim2.new(1, 0, 0, 30)
    TitleBar.Position = UDim2.new(0, 0, 0, 0)
    TitleBar.BackgroundColor3 = DARK_GRAY_HEADER
    TitleBar.BackgroundTransparency = 0
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 12)
    TitleCorner.Parent = TitleBar

    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Text = "JohnAim"
    Title.Size = UDim2.new(0.7, 0, 1, 0)
    Title.Position = UDim2.new(0.05, 0, 0, 0)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = PURPLE_ACCENT
    Title.Font = MAIN_FONT
    Title.TextSize = 14
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = TitleBar

    -- Только кнопка закрытия (без minimize)
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(1, -30, 0, 0)
    CloseButton.BackgroundColor3 = DARK_GRAY_HEADER
    CloseButton.BackgroundTransparency = 0
    CloseButton.Text = "X"
    CloseButton.TextColor3 = RED_CLOSE
    CloseButton.Font = SPECIAL_FONT
    CloseButton.TextSize = 14
    CloseButton.TextYAlignment = Enum.TextYAlignment.Center
    CloseButton.Parent = TitleBar

    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 12)
    CloseCorner.Parent = CloseButton

    -- Кнопки функций
    local buttonHeight = 30
    local buttonSpacing = 5
    local currentY = 35

    local function CreateButton(name, text, yPos, callback)
        local button = Instance.new("TextButton")
        button.Name = name
        button.Size = UDim2.new(0.9, 0, 0, buttonHeight)
        button.Position = UDim2.new(0.05, 0, 0, yPos)
        button.BackgroundColor3 = DARK_GRAY_HEADER
        button.BackgroundTransparency = 0
        button.Text = text
        button.TextColor3 = WHITE_TEXT
        button.Font = MAIN_FONT
        button.TextSize = 12
        button.Parent = MainFrame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = button
        
        button.MouseButton1Click:Connect(function()
            callback(button)
        end)
        
        return button
    end

    -- Auto Get Gun Toggle
    local AutoGunButton = CreateButton("AutoGunButton", "AUTO GUN: OFF", currentY, function(btn)
        AutoGetGun.Enabled = not AutoGetGun.Enabled
        btn.Text = "AUTO GUN: " .. (AutoGetGun.Enabled and "ON" or "OFF")
        btn.BackgroundColor3 = AutoGetGun.Enabled and PURPLE_ACCENT or DARK_GRAY_HEADER
        
        if AutoGetGun.Enabled then
            spawn(function()
                while AutoGetGun.Enabled and IsLoaded() do
                    teleportToGunAndBack()
                    task.wait(0.5)
                end
            end)
        end
    end)

    currentY = currentY + buttonHeight + buttonSpacing

    -- ESP Toggle (выключен по умолчанию)
    local ESPButton = CreateButton("ESPButton", "ESP: OFF", currentY, function(btn)
        ESPEnabled = not ESPEnabled
        btn.Text = "ESP: " .. (ESPEnabled and "ON" or "OFF")
        btn.BackgroundColor3 = ESPEnabled and PURPLE_ACCENT or DARK_GRAY_HEADER
        
        if not ESPEnabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    local highlight = player.Character:FindFirstChild("Highlight")
                    if highlight then
                        highlight:Destroy()
                    end
                end
            end
        end
    end)

    -- Перемещение MainFrame через TitleBar
    local dragging, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)

    -- Закрытие окна
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
        MainGUI = nil
    end)

    return ScreenGui
end

-- Функция создания Shoot GUI
local function CreateShootGUI()
    if ShootGUI and ShootGUI.Parent then return end
    if ShootGUI then ShootGUI:Destroy() end

    local ShootScreenGui = Instance.new("ScreenGui")
    ShootScreenGui.Name = "JohnAimShootGUI"
    ShootScreenGui.ResetOnSpawn = false
    ShootScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    ShootGUI = ShootScreenGui

    -- Основной контейнер
    local ShootContainer = Instance.new("Frame")
    ShootContainer.Name = "ShootContainer"
    ShootContainer.Size = UDim2.new(0, 70, 0, 85) -- Кнопка 70x70 + ручка 15
    ShootContainer.Position = UDim2.new(1, -110, 0.5, -42.5) -- Сдвинуто дальше от края
    ShootContainer.BackgroundTransparency = 1
    ShootContainer.Parent = ShootScreenGui

    -- Кнопка Shoot (квадратная)
    local ShootButton = Instance.new("TextButton")
    ShootButton.Name = "ShootButton"
    ShootButton.Size = UDim2.new(1, 0, 0, 70)
    ShootButton.Position = UDim2.new(0, 0, 0, 0)
    ShootButton.BackgroundColor3 = DARK_GRAY_HEADER
    ShootButton.TextColor3 = WHITE_TEXT
    ShootButton.Font = MAIN_FONT
    ShootButton.TextSize = 14
    ShootButton.Text = "SHOOT"
    ShootButton.Parent = ShootContainer

    local UICornerButton = Instance.new("UICorner")
    UICornerButton.CornerRadius = UDim.new(0, 8)
    UICornerButton.Parent = ShootButton

    -- Ручка для перемещения (под кнопкой)
    local ShootDragHandle = Instance.new("Frame")
    ShootDragHandle.Name = "ShootDragHandle"
    ShootDragHandle.Size = UDim2.new(1, 0, 0, 15)
    ShootDragHandle.Position = UDim2.new(0, 0, 0, 70)
    ShootDragHandle.BackgroundColor3 = DARK_GRAY_HEADER
    ShootDragHandle.BackgroundTransparency = 0.7
    ShootDragHandle.BorderSizePixel = 0
    ShootDragHandle.Parent = ShootContainer

    local UICornerHandle = Instance.new("UICorner")
    UICornerHandle.CornerRadius = UDim.new(0, 6)
    UICornerHandle.Parent = ShootDragHandle

    -- Функция для ShootButton
    ShootButton.MouseButton1Click:Connect(function()
        if not IsLoaded() then return end
        
        TweenService:Create(ShootButton, TweenInfo.new(0.1), {Size = UDim2.new(0.95, 0, 0, 66)}):Play()
        task.wait(0.1)
        TweenService:Create(ShootButton, TweenInfo.new(0.1), {Size = UDim2.new(1, 0, 0, 70)}):Play()

        local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local backpack = LocalPlayer:WaitForChild("Backpack")
        local gun = backpack:FindFirstChild("Gun") or char:FindFirstChild("Gun")

        if gun then
            char:WaitForChild("Humanoid"):EquipTool(gun)
            task.wait(0.2)

            local murderer = nil
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    local knife = player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife")
                    if knife then
                        murderer = player
                        break
                    end
                end
            end

            if murderer and murderer.Character and murderer.Character:FindFirstChild("HumanoidRootPart") then
                local targetChar = murderer.Character
                local targetPos = targetChar.HumanoidRootPart.Position
                local targetVel = targetChar.HumanoidRootPart.Velocity

                local bulletSpeed = 300
                local distance = (targetPos - char.HumanoidRootPart.Position).Magnitude
                local leadPos = targetPos + (targetVel * (distance / bulletSpeed))

                local success, err = pcall(function()
                    local gunRemote = workspace:WaitForChild(LocalPlayer.Name):WaitForChild("Gun")
                        :WaitForChild("KnifeLocal"):WaitForChild("CreateBeam"):WaitForChild("RemoteFunction")
                    gunRemote:InvokeServer(1, leadPos, "AH2")

                    ShootButton.Text = "SHOT!"
                    ShootButton.BackgroundColor3 = PURPLE_ACCENT
                    task.wait(1)
                    ShootButton.Text = "SHOOT"
                    ShootButton.BackgroundColor3 = DARK_GRAY_HEADER
                end)
            else
                ShootButton.Text = "NO TARGET"
                ShootButton.BackgroundColor3 = GRAY_NOTE
                task.wait(1)
                ShootButton.Text = "SHOOT"
                ShootButton.BackgroundColor3 = DARK_GRAY_HEADER
            end
        else
            ShootButton.Text = "NO GUN"
            ShootButton.BackgroundColor3 = GRAY_NOTE
            task.wait(1)
            ShootButton.Text = "SHOOT"
            ShootButton.BackgroundColor3 = DARK_GRAY_HEADER
        end
    end)

    -- Перемещение ShootContainer через ShootDragHandle
    local shootDragging, shootDragStart, shootStartPos

    local function updateShootPos(input)
        local delta = input.Position - shootDragStart
        ShootContainer.Position = UDim2.new(shootStartPos.X.Scale, shootStartPos.X.Offset + delta.X, shootStartPos.Y.Scale, shootStartPos.Y.Offset + delta.Y)
    end

    ShootDragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            shootDragging = true
            shootDragStart = input.Position
            shootStartPos = ShootContainer.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    shootDragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if shootDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            updateShootPos(input)
        end
    end)

    return ShootScreenGui
end

-- Основной цикл
local function MainLoop()
    while task.wait(0.1) and IsLoaded() do
        -- Обновление ролей для ESP
        if ReplicatedStorage:FindFirstChild("GetPlayerData", true) then
            roles = ReplicatedStorage:FindFirstChild("GetPlayerData", true):InvokeServer()
            for i, v in pairs(roles) do
                if v.Role == "Murderer" then
                    Murder = i
                elseif v.Role == 'Sheriff'then
                    Sheriff = i
                elseif v.Role == 'Hero'then
                    Hero = i
                end
            end
            
            -- Обновление ESP (если включен)
            if ESPEnabled then
                CreateHighlight()
                UpdateHighlights()
            end
        end
        
        -- Авто-подбор оружия
        if AutoGetGun.Enabled and not isMurderer() then
            teleportToGunAndBack()
        end
    end
end

-- Инициализация
local function Initialize()
    -- Проверка на уже запущенный скрипт
    if _G.JohnAimLoaded then return end
    _G.JohnAimLoaded = true

    -- Ждем загрузки игры
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    task.wait(3)

    -- Создаем GUI
    CreateMainGUI()
    CreateShootGUI()
    
    -- Запускаем основной цикл
    spawn(MainLoop)

    -- Анти-АФК
    local VirtualUser = game:GetService("VirtualUser")
    LocalPlayer.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end

-- Очистка при выходе
Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        _G.JohnAimLoaded = false
        if MainGUI then MainGUI:Destroy() end
        if ShootGUI then ShootGUI:Destroy() end
    end
end)

-- Запуск
Initialize()
