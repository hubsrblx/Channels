-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
if _G.MM2UltimateScriptIsLoaded then return end
_G.MM2UltimateScriptIsLoaded = true

-- MM2 Ultimate Script v1.1
-- –í–∫–ª—é—á–∞–µ—Ç: ESP, Auto Gun, Aimbot

-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
_G.IsLoading = true

-- ========== –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò ==========
local function ShowLoadingScreen()
    for _, gui in ipairs(game.CoreGui:GetChildren()) do
        if gui.Name:find("LoadingScreen_") then
            gui:Destroy()
        end
    end

    local LoadingGui = Instance.new("ScreenGui")
    LoadingGui.Name = "LoadingScreen_"..math.random(1, 9999)
    LoadingGui.Parent = game.CoreGui
    LoadingGui.ResetOnSpawn = false

    local LoadingFrame = Instance.new("Frame")
    LoadingFrame.Name = "LoadingFrame"
    LoadingFrame.Size = UDim2.new(0, 300, 0, 150)
    LoadingFrame.AnchorPoint = Vector2.new(1, 0)
    LoadingFrame.Position = UDim2.new(1, -10, 0, 10)
    LoadingFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    LoadingFrame.BackgroundTransparency = 0.03
    LoadingFrame.BorderSizePixel = 0
    LoadingFrame.Parent = LoadingGui

    local UIStroke = Instance.new("UIStroke")
    UIStroke.Thickness = 2
    UIStroke.Color = Color3.fromRGB(100, 100, 100)
    UIStroke.Transparency = 0.5
    UIStroke.Parent = LoadingFrame

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = LoadingFrame

    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.Position = UDim2.new(0, 0, 0, 10)
    Title.BackgroundTransparency = 1
    Title.Text = "MM2 Ultimate"
    Title.TextColor3 = Color3.fromRGB(170, 0, 255)
    Title.Font = Enum.Font.ArimoBold
    Title.TextSize = 24
    Title.Parent = LoadingFrame

    local PercentText = Instance.new("TextLabel")
    PercentText.Name = "PercentText"
    PercentText.Size = UDim2.new(1, 0, 0, 40)
    PercentText.Position = UDim2.new(0, 0, 0, 50)
    PercentText.BackgroundTransparency = 1
    PercentText.Text = "0%"
    PercentText.TextColor3 = Color3.fromRGB(170, 0, 255)
    PercentText.Font = Enum.Font.LuckiestGuy
    PercentText.TextSize = 30
    PercentText.Parent = LoadingFrame

    local LoadingText = Instance.new("TextLabel")
    LoadingText.Name = "LoadingText"
    LoadingText.Size = UDim2.new(1, 0, 0, 20)
    LoadingText.Position = UDim2.new(0, 0, 0, 90)
    LoadingText.BackgroundTransparency = 1
    LoadingText.Text = "LOADING"
    LoadingText.TextColor3 = Color3.fromRGB(255, 255, 255)
    LoadingText.Font = Enum.Font.LuckiestGuy
    LoadingText.TextSize = 14
    LoadingText.Parent = LoadingFrame

    local startTime = tick()
    local duration = 20
    
    while tick() < startTime + duration do
        local elapsed = tick() - startTime
        local progress = math.min(elapsed / duration, 1)
        PercentText.Text = math.floor(progress * 100) .. "%"
        task.wait(0.05)
    end
    
    LoadingGui:Destroy()
    _G.IsLoading = false
end

-- ========== –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ==========
local BLACK_MAIN = Color3.fromRGB(25, 25, 25)
local BLACK_MAIN_TRANSPARENCY = 0.03
local PURPLE_ACCENT = Color3.fromRGB(170, 0, 255)
local PURPLE_ACCENT_TRANSPARENCY = 0
local WHITE_TEXT = Color3.fromRGB(255, 255, 255)
local PURPLE_HEADER = Color3.fromRGB(170, 0, 255)
local DARK_GRAY_HEADER = Color3.fromRGB(40, 40, 40)
local DARK_GRAY_HEADER_TRANSPARENCY = 0
local RED_CLOSE = Color3.fromRGB(255, 80, 80)
local GRAY_NOTE = Color3.fromRGB(170, 170, 170)

local MAIN_FONT = Enum.Font.ArimoBold
local SPECIAL_FONT = Enum.Font.FredokaOne

local TEXT_TITLE = "MM2 Ultimate"
local TEXT_MINIMIZE = "-"
local TEXT_CLOSE = "X"
local TEXT_ESP = "ESP - üëÅÔ∏è"
local TEXT_AUTO_GUN = "Auto Gun - üî´"
local TEXT_AIMBOT = "Aimbot - üéØ"

local TEXT_SIZE_TITLE = 18
local TEXT_SIZE_BUTTON = 14
local TEXT_SIZE_NOTE = 10

local Player = game.Players.LocalPlayer
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local ESPEnabled = false
local AutoGunEnabled = false
local AimbotEnabled = false
local MainGUI = nil
local Murder = nil
local Sheriff = nil
local Hero = nil
local roles = {}
local RoundActive = false

-- ========== –ò–ì–†–û–í–´–ï –°–û–ë–´–¢–ò–Ø ==========
local function SetupGameEvents()
    -- –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Ä–∞—É–Ω–¥–∞
    local roundStartEvent = ReplicatedStorage:FindFirstChild("RoundStart", true)
    local roundEndEvent = ReplicatedStorage:FindFirstChild("RoundEnd", true) or ReplicatedStorage:FindFirstChild("RoundEndFade", true)

    if roundStartEvent then
        roundStartEvent.OnClientEvent:Connect(function()
            RoundActive = true
        end)
    end

    if roundEndEvent then
        roundEndEvent.OnClientEvent:Connect(function()
            RoundActive = false
        end)
    end
end

-- ========== ESP –§–£–ù–ö–¶–ò–ò ==========
local function CreateHighlight()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Player and player.Character and not player.Character:FindFirstChild("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "Highlight"
            highlight.Parent = player.Character
        end
    end
end

local function UpdateHighlights()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Player and player.Character and player.Character:FindFirstChild("Highlight") then
            local highlight = player.Character:FindFirstChild("Highlight")
            
            if player.Name == Murder then
                highlight.FillColor = Color3.fromRGB(255, 0, 0)
            elseif player.Name == Sheriff then
                highlight.FillColor = Color3.fromRGB(0, 0, 255)
            elseif player.Name == Hero then
                highlight.FillColor = Color3.fromRGB(255, 255, 0)
            else
                highlight.FillColor = Color3.fromRGB(0, 255, 0)
            end
        end
    end
end

local function ESPLoop()
    while ESPEnabled do
        roles = ReplicatedStorage:FindFirstChild("GetPlayerData", true):InvokeServer()
        for name, data in pairs(roles) do
            if data.Role == "Murderer" then
                Murder = name
            elseif data.Role == 'Sheriff' then
                Sheriff = name
            elseif data.Role == 'Hero' then
                Hero = name
            end
        end
        
        CreateHighlight()
        UpdateHighlights()
        task.wait(1)
    end
end

-- ========== AUTO GUN –§–£–ù–ö–¶–ò–ò ==========
local function isMurderer()
    local char = Player.Character
    if not char then return false end
    return char:FindFirstChild("Knife") or Player.Backpack:FindFirstChild("Knife")
end

local function getNearestGun()
    local char = Player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local root = char.HumanoidRootPart

    local closestGun, closestDist = nil, 5000
    for _, item in ipairs(workspace:GetDescendants()) do
        if item.Name == "GunDrop" and item:IsA("BasePart") then
            local dist = (root.Position - item.Position).Magnitude
            if dist < closestDist then
                closestGun, closestDist = item, dist
            end
        end
    end
    return closestGun
end

local function autoGetGunLoop()
    while AutoGunEnabled do
        if RoundActive and not isMurderer() then
            local char = Player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local gun = getNearestGun()
                if gun then
                    local root = char.HumanoidRootPart
                    local originalPos = root.CFrame
                    
                    -- –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º—Å—è –∫ –ø—É—à–∫–µ
                    root.CFrame = CFrame.new(gun.Position + Vector3.new(0, 2, 0))
                    
                    -- –ñ–¥–µ–º –ø–æ–∫–∞ –ø–æ–¥–±–µ—Ä–µ—Ç—Å—è –∏–ª–∏ 2 —Å–µ–∫—É–Ω–¥—ã
                    local timeout = tick() + 2
                    while gun.Parent and tick() < timeout do
                        task.wait(0.1)
                    end
                    
                    -- –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –º–µ—Å—Ç–æ
                    root.CFrame = originalPos
                end
            end
        end
        task.wait(0.5)
    end
end

-- ========== AIMBOT –§–£–ù–ö–¶–ò–ò ==========
local function shootAtMurderer()
    if not RoundActive then return end
    
    local char = Player.Character
    if not char then return end
    
    local gun = char:FindFirstChild("Gun") or Player.Backpack:FindFirstChild("Gun")
    if not gun then return end

    -- –≠–∫–∏–ø–∏—Ä—É–µ–º –ø—É—à–∫—É
    char:WaitForChild("Humanoid"):EquipTool(gun)
    task.wait(0.2)

    -- –ò—â–µ–º –º–∞–Ω—å—è–∫–∞
    local murderer = nil
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Player and player.Character then
            local knife = player.Character:FindFirstChild("Knife") or player.Backpack:FindFirstChild("Knife")
            if knife then
                murderer = player
                break
            end
        end
    end

    if murderer and murderer.Character and murderer.Character:FindFirstChild("HumanoidRootPart") then
        local targetChar = murderer.Character
        local targetPos = targetChar.HumanoidRootPart.Position
        local targetVel = targetChar.HumanoidRootPart.Velocity

        local bulletSpeed = 300
        local distance = (targetPos - char.HumanoidRootPart.Position).Magnitude
        local leadPos = targetPos + (targetVel * (distance / bulletSpeed))

        pcall(function()
            local gunRemote = workspace:WaitForChild(Player.Name):WaitForChild("Gun")
                :WaitForChild("KnifeLocal"):WaitForChild("CreateBeam"):WaitForChild("RemoteFunction")
            gunRemote:InvokeServer(1, leadPos, "AH2")
        end)
    end
end

local function aimbotLoop()
    while AimbotEnabled do
        if RoundActive and Player:GetAttribute("Alive") then
            shootAtMurderer()
        end
        task.wait(0.5)
    end
end

-- ========== GUI –§–£–ù–ö–¶–ò–ò ==========
local function CreateMainGUI()
    if MainGUI then
        MainGUI:Destroy()
        MainGUI = nil
    end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MM2UltimateScript"
    ScreenGui.Parent = game.CoreGui
    ScreenGui.ResetOnSpawn = false
    MainGUI = ScreenGui

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 300, 0, 220)
    MainFrame.AnchorPoint = Vector2.new(1, 0)
    MainFrame.Position = UDim2.new(1, -10, 0, 10)
    MainFrame.BackgroundColor3 = BLACK_MAIN
    MainFrame.BackgroundTransparency = BLACK_MAIN_TRANSPARENCY
    MainFrame.BorderSizePixel = 0
    MainFrame.Parent = ScreenGui

    local UIStroke = Instance.new("UIStroke")
    UIStroke.Thickness = 2
    UIStroke.Color = Color3.fromRGB(100, 100, 100)
    UIStroke.Transparency = 0.5
    UIStroke.Parent = MainFrame

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = MainFrame

    -- –ó–∞–≥–æ–ª–æ–≤–æ–∫
    local TitleBar = Instance.new("Frame")
    TitleBar.Name = "TitleBar"
    TitleBar.Size = UDim2.new(1, 0, 0, 30)
    TitleBar.Position = UDim2.new(0, 0, 0, 0)
    TitleBar.BackgroundColor3 = DARK_GRAY_HEADER
    TitleBar.BackgroundTransparency = DARK_GRAY_HEADER_TRANSPARENCY
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame

    local TitleCorner = Instance.new("UICorner")
    TitleCorner.CornerRadius = UDim.new(0, 12)
    TitleCorner.Parent = TitleBar

    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Size = UDim2.new(0.7, 0, 1, 0)
    Title.Position = UDim2.new(0.05, 0, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = TEXT_TITLE
    Title.TextColor3 = PURPLE_HEADER
    Title.Font = MAIN_FONT
    Title.TextSize = TEXT_SIZE_TITLE
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.TextYAlignment = Enum.TextYAlignment.Center
    Title.Parent = TitleBar

    local MinimizeButton = Instance.new("TextButton")
    MinimizeButton.Name = "MinimizeButton"
    MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
    MinimizeButton.Position = UDim2.new(1, -60, 0, 0)
    MinimizeButton.BackgroundColor3 = DARK_GRAY_HEADER
    MinimizeButton.BackgroundTransparency = DARK_GRAY_HEADER_TRANSPARENCY
    MinimizeButton.Text = TEXT_MINIMIZE
    MinimizeButton.TextColor3 = WHITE_TEXT
    MinimizeButton.Font = SPECIAL_FONT
    MinimizeButton.TextSize = TEXT_SIZE_TITLE
    MinimizeButton.TextYAlignment = Enum.TextYAlignment.Center
    MinimizeButton.Parent = TitleBar

    local MinimizeCorner = Instance.new("UICorner")
    MinimizeCorner.CornerRadius = UDim.new(0, 12)
    MinimizeCorner.Parent = MinimizeButton

    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(1, -30, 0, 0)
    CloseButton.BackgroundColor3 = DARK_GRAY_HEADER
    CloseButton.BackgroundTransparency = DARK_GRAY_HEADER_TRANSPARENCY
    CloseButton.Text = TEXT_CLOSE
    CloseButton.TextColor3 = RED_CLOSE
    CloseButton.Font = SPECIAL_FONT
    CloseButton.TextSize = TEXT_SIZE_TITLE
    CloseButton.TextYAlignment = Enum.TextYAlignment.Center
    CloseButton.Parent = TitleBar

    local CloseCorner = Instance.new("UICorner")
    CloseCorner.CornerRadius = UDim.new(0, 12)
    CloseCorner.Parent = CloseButton

    -- –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è GUI
    local isMinimized = false
    local originalSize = MainFrame.Size
    local minimizedSize = UDim2.new(0, 300, 0, 30)
    local childrenVisibility = {}

    local function ToggleMinimize()
        isMinimized = not isMinimized
        if isMinimized then
            for _, child in ipairs(MainFrame:GetChildren()) do
                if child ~= TitleBar and child ~= UICorner and child ~= UIStroke then
                    childrenVisibility[child] = child.Visible
                    child.Visible = false
                end
            end
            MainFrame.Size = minimizedSize
        else
            MainFrame.Size = originalSize
            for child, visible in pairs(childrenVisibility) do
                child.Visible = visible
            end
            childrenVisibility = {}
        end
    end

    MinimizeButton.MouseButton1Click:Connect(ToggleMinimize)

    -- –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ GUI
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        MainFrame.Position = newPos
    end

    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    -- –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
    local buttonHeight = 35
    local buttonSpacing = 8
    local currentY = 35

    local function CreateButton(name, text, yPos, callback)
        local button = Instance.new("TextButton")
        button.Name = name
        button.Size = UDim2.new(0.8, 0, 0, buttonHeight)
        button.Position = UDim2.new(0.1, 0, 0, yPos)
        button.BackgroundColor3 = DARK_GRAY_HEADER
        button.BackgroundTransparency = DARK_GRAY_HEADER_TRANSPARENCY
        button.Text = text..": OFF"
        button.TextColor3 = WHITE_TEXT
        button.Font = MAIN_FONT
        button.TextSize = TEXT_SIZE_BUTTON
        button.TextYAlignment = Enum.TextYAlignment.Center
        button.Parent = MainFrame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = button
        
        button.MouseButton1Click:Connect(function()
            if _G.IsLoading then return end
            callback(button)
        end)
        return button
    end

    -- –ö–Ω–æ–ø–∫–∞ ESP
    local espBtn = CreateButton("ESP_TOGGLE", TEXT_ESP, currentY, function(btn)
        ESPEnabled = not ESPEnabled
        btn.Text = TEXT_ESP..(ESPEnabled and ": ON" or ": OFF")
        btn.BackgroundColor3 = ESPEnabled and PURPLE_ACCENT or DARK_GRAY_HEADER
        btn.BackgroundTransparency = ESPEnabled and PURPLE_ACCENT_TRANSPARENCY or DARK_GRAY_HEADER_TRANSPARENCY
        
        if ESPEnabled then
            spawn(ESPLoop)
        else
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= Player and player.Character and player.Character:FindFirstChild("Highlight") then
                    player.Character:FindFirstChild("Highlight"):Destroy()
                end
            end
        end
    end)
    currentY = currentY + buttonHeight + buttonSpacing

    -- –ö–Ω–æ–ø–∫–∞ Auto Gun
    local autoGunBtn = CreateButton("AUTO_GUN_TOGGLE", TEXT_AUTO_GUN, currentY, function(btn)
        AutoGunEnabled = not AutoGunEnabled
        btn.Text = TEXT_AUTO_GUN..(AutoGunEnabled and ": ON" or ": OFF")
        btn.BackgroundColor3 = AutoGunEnabled and PURPLE_ACCENT or DARK_GRAY_HEADER
        btn.BackgroundTransparency = AutoGunEnabled and PURPLE_ACCENT_TRANSPARENCY or DARK_GRAY_HEADER_TRANSPARENCY
        
        if AutoGunEnabled then
            spawn(autoGetGunLoop)
        end
    end)
    currentY = currentY + buttonHeight + buttonSpacing

    -- –ö–Ω–æ–ø–∫–∞ Aimbot
    local aimbotBtn = CreateButton("AIMBOT_TOGGLE", TEXT_AIMBOT, currentY, function(btn)
        AimbotEnabled = not AimbotEnabled
        btn.Text = TEXT_AIMBOT..(AimbotEnabled and ": ON" or ": OFF")
        btn.BackgroundColor3 = AimbotEnabled and PURPLE_ACCENT or DARK_GRAY_HEADER
        btn.BackgroundTransparency = AimbotEnabled and PURPLE_ACCENT_TRANSPARENCY or DARK_GRAY_HEADER_TRANSPARENCY
        
        if AimbotEnabled then
            spawn(aimbotLoop)
        end
    end)

    -- –ó–∞–∫—Ä—ã—Ç–∏–µ GUI
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
        _G.MM2UltimateScriptIsLoaded = false
        _G.IsLoading = nil
        MainGUI = nil
        
        -- –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        ESPEnabled = false
        AutoGunEnabled = false
        AimbotEnabled = false
        
        -- –£–¥–∞–ª—è–µ–º –≤—Å–µ Highlight
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player and player.Character and player.Character:FindFirstChild("Highlight") then
                player.Character:FindFirstChild("Highlight"):Destroy()
            end
        end
    end)

    return ScreenGui
end

-- ========== –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´ ==========
spawn(ShowLoadingScreen)

if not game:IsLoaded() then
    game.Loaded:Wait()
end
task.wait(3)

-- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
SetupGameEvents()

-- –°–æ–∑–¥–∞–µ–º GUI –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
while _G.IsLoading do task.wait() end
CreateMainGUI()

-- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
game:GetService("Players").PlayerRemoving:Connect(function(player)
    if player == Player then
        _G.MM2UltimateScriptIsLoaded = false
        _G.IsLoading = nil
        if MainGUI then
            MainGUI:Destroy()
            MainGUI = nil
        end
        
        ESPEnabled = false
        AutoGunEnabled = false
        AimbotEnabled = false
        
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player and player.Character and player.Character:FindFirstChild("Highlight") then
                player.Character:FindFirstChild("Highlight"):Destroy()
            end
        end
    end
end)
